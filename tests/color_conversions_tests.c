#include "tests.h"
#include "galba_colormath.h"


#include <stdio.h>
#include <math.h>

static bool rgb_equals(rgb_t l, rgb_t r){
	return l.r == r.r && l.g == r.g && l.b == r.b;
}

static bool xyz_equals(xyz_t l, xyz_t r){
	return l.x == r.x && l.y == r.y && l.z == r.z;
}

static bool lab_equals(lab_t l, lab_t r){
	return l.a == r.a && l.l == r.l && l.b == r.b;
}

static void print_rgb(rgb_t p){
    printf("rgb(%u %u %u)", p.r, p.g, p.b);
}
static void print_lab(lab_t p){
    printf("lab(%lf %lf %lf)", p.l, p.a, p.b);
}
static void print_xyz(xyz_t p){
    printf("xyz(%lf %lf %lf)", p.x, p.y, p.z);
}

static double round_to_n_digits(double x, unsigned int digits) {
    double fac = pow(10, digits);
    return round(x* fac)/ fac;
}

static xyz_t round_xyz(xyz_t x, unsigned int digits){
	x.x = round_to_n_digits(x.x, digits);
	x.y = round_to_n_digits(x.y, digits);
	x.z = round_to_n_digits(x.z, digits);

	return x;
}

static lab_t round_lab(lab_t x, unsigned int digits){
	x.l = round_to_n_digits(x.l, digits);
	x.a = round_to_n_digits(x.a, digits);
	x.b = round_to_n_digits(x.b, digits);

	return x;
}



// exhaustively tests all RGB values whether they dont change if round trip RGB -> LAB -> RGB is made
bool test_RGB_LAB_roundtrip(void){
    long different = 0;
    for(long i = 0; i< 256*256*256 ;i++){
    	rgb_t start = RGB_from_i32(i);
    	rgb_t end = RGB_from_XYZ(XYZ_from_LAB(LAB_from_XYZ(XYZ_from_RGB(start))));
    	if(!rgb_equals(start, end)){
    		different += 1;
    	}
    }
    if(different != 0){
    	printf("FAILED: test_RGB_LAB_roundtrip, RGB->LAB->RGB round trip returned wrong RGB for %ld values\n", different);
    	return false;
    }else{
	    puts("SUCCESS");
	    return true;
    }

}


#define XYZ_LAB_TRIP_COUNT 100
const xyz_t XYZ_LAB_TRIP_CASES[XYZ_LAB_TRIP_COUNT] = { 
	{19.074259708006924, 1.961511990585862, -12.62824008474858}, {41.18203772557023, -85.66476680604316, 13.28278275039093},
	{86.96849938157338, 11.732725030909705, -80.141939388551}, {59.660931407443485, -94.88031231734968, -97.4949004103237},
	{95.49241851009332, 86.15954362497132, 9.03652044019290}, {12.272447057256585, 66.30476531815876, -97.0518986437556},
	{8.874243281424587, -88.02778963753899, 10.98650839657443}, {98.4597146597517, -31.87601857599556, 97.2277146509022},
	{97.24330824953475, -53.48255235230381, -121.6977955216243}, {54.60476878881316, -109.11190101526266, 2.102149589313654},
	{29.269244050056066, -68.46000302117605, -53.7090871623873}, {50.535891499450905, -91.66940371914089, -10.83708942493815},
	{4.053110683746485, 46.76291952887837, -10.2974212680940}, {47.758717173327334, -88.42087379638019, -97.5238031480408},
	{75.63369634672684, 3.7744826120633945, -2.32683586900694}, {34.28452009911891, -74.35741643948853, 85.2575083151657},
	{76.57489827836899, -93.96579599384697, -42.9919178551268}, {41.55391214814526, 41.33745062809186, 3.442572080293871},
	{26.97951281486435, -57.924389712402856, 11.3254670687}, {28.620942229799528, -97.07307461800914, -3.811597997365055},
	{24.543271030270684, 66.10771820485243, -45.73834230556120}, {24.377487865384296, 83.84652525357541, -66.3058794249391},
	{94.14821821202666, 77.57960626738415, 67.9548063841644}, {58.294365100900805, -96.51009009310724, 62.0725644870190},
	{38.25635365207516, -64.26358792571163, -43.51363102875579}, {75.38098501624731, -61.548507431090165, 85.1826448952169},
	{22.5590373264838, 27.78326934251288, 53.4053501974406}, {90.12981181851573, 118.40658938109965, -1.66200924786730},
	{68.05181652566291, -25.42506196571354, -37.848783506147}, {47.89901819798851, 15.694015679652239, 114.1173268816944},
	{42.803648848231504, -59.424699739424625, -91.1862875806500}, {82.71077514932664, 118.46441031672887, -11.73356981302431},
	{47.95493608450075, -60.3206888069858, -75.2259328892227}, {49.74243758364276, 57.03350447603367, -88.6049182949232},
	{24.25952239902123, -51.32940136204353, -39.444690028699}, {38.563651409881274, 107.8783815211024, -93.9398819718997},
	{87.58085022324322, 97.15829020711124, 83.6819255808225}, {15.6698972273006, 98.95470748137038, 122.9927884272891},
	{9.274659954087404, -60.03300365361747, 75.2973813900416}, {32.620052328824144, 48.753019653305415, -79.2551318623355},
	{85.5414296241987, 87.89973014909987, -58.1566227146646}, {92.03090320260739, -71.20205971979945, -121.9430492634366},
	{43.241763731815965, -77.01501823768803, -105.5447059065166}, {69.19416574446731, -85.95032642892068, -119.604144859384},
	{96.55047241636353, -117.44848903160074, -69.2142437264166}, {97.66485989030632, -40.368091586364486, 28.009099166490},
	{90.62523024733864, 14.430172961794625, -10.67781448882912}, {64.7915872869482, -79.12201445560754, 60.9684353141272},
	{30.295524680567098, 83.34820127012281, -40.70398891202755}, {7.901312233387658, -107.75313312868923, -91.5681072780951},
	{25.036124919339077, -7.562601853093852, 88.5431745654273}, {56.405013744363075, 40.78397484822406, 27.95705285474181},
	{4.780743748284233, -14.185187917688907, -81.1569304922229}, {78.07473085204747, 108.92403242323456, -59.0554351606465},
	{30.070354310839964, -25.065905190819336, -122.5539487754832}, {77.24765791480377, -25.991481738599447, -3.80587833968002},
	{17.968995744891725, 27.69930191289353, -111.479565240305}, {86.1022931469558, -47.083045590791514, 117.9646410255389},
	{52.38247028678493, -112.38237232558329, 12.8690547444801}, {78.10643143575535, -117.97703326592412, 20.14878350506941},
	{9.35463151619218, 2.3398216501176705, -113.2715632387381}, {16.473498352808168, -89.15466533688723, -113.6097684981163},
	{80.85436266156034, -122.02684068520786, 44.50384341315026}, {84.46779323179585, -5.387394694797678, 19.82142342873649},
	{88.73876819749913, 110.45857747440502, 69.4811914018477}, {52.99218129044203, 102.64504129597228, -58.3339870300628},
	{29.579628249903756, -64.80667805584503, 94.2609584892787}, {90.02173146583179, -98.33034062715407, -97.395092928647},
	{77.01230014315263, 53.018126679862064, 123.624961807909}, {18.081956043174085, 18.42867843109738, 92.1801788813726},
	{70.45663267352118, -27.443341521105864, -54.99578761098524}, {12.17152307115149, -0.37003530982818233, -121.8679637341669},
	{81.41289408050235, 23.385114720586927, -36.40353064776813}, {99.27010393072356, -15.46632501871234, 18.14965705535746},
	{88.30895572311717, 34.32299526814293, 95.5089056528551}, {89.19290025814726, 102.25501412817854, -45.20081720820884},
	{35.749890143532824, 70.76727375234083, -46.1464261827290}, {26.603886031408365, -109.6220006936395, 113.3380605852002},
	{92.61337830983464, 51.66403581072407, -113.9262777222185}, {95.75984658759793, -12.325601760341755, -72.0811343204047},
	{19.010009544454043, -7.892944270444573, 113.9294917535887}, {71.25715551004807, 95.65330427449081, 29.71466247228542},
	{93.07413446952575, 80.6592569504217, -80.9634823721437}, {88.84631640290004, -115.92271129456591, 104.9102362581210},
	{45.347654476762855, 106.7386902258936, 1.684905340219145}, {47.168963639976624, 124.06428133453778, -107.4560284234142},
	{56.872607669164225, -0.5252013683366101, 74.0842905704614}, {48.018232608751546, -34.98865299936027, -46.9436481815662},
	{82.97831485518981, -111.18446252136785, 72.566003506806}, {25.259830266528294, -18.787156389410896, 109.1093783637807},
	{75.59044111102538, -99.9053130868266, 29.30848846585678}, {57.381099807995675, -94.4824047903452, -120.6265768697670},
	{47.62154598005761, 40.229894736440656, 120.7313306542937}, {8.749343337750215, -41.89573570101463, 88.1095643727403},
	{89.84322300957567, -13.792322718593766, 63.8488425048231}, {88.36861596118001, 124.58125630118968, 98.8190422905426},
	{38.014579825704075, -20.55966039351425, -89.6370678637382}, {68.60246382789741, 49.504731858182964, -55.42414856682684},
	{99.40319140154949, 33.65668148405442, 19.22922551937608}, {15.638910934930639, -54.52713136510987, -123.0114701971984},
};

bool test_XYZ_LAB_roundtrip(void){
 	long different = 0;
    for(long i = 0; i< XYZ_LAB_TRIP_COUNT ;i++){
    	xyz_t start = XYZ_LAB_TRIP_CASES[i];
    	xyz_t end = XYZ_from_LAB(LAB_from_XYZ(start));
    	start = round_xyz(start, 5);
    	end = round_xyz(end, 5);

    	if(!xyz_equals(start, end)){
    		different += 1;
    	}


    }
    if(different != 0){
    	printf("FAILED: test_XYZ_LAB_roundtrip, XYZ->LAB->XYZ round trip returned wrong XYZ for %ld values\n", different);
    	return false;
    }else{
	    puts("SUCCESS");
	    return true;
    }

}


#define LAB_XYZ_TRIP_COUNT 50

const lab_t LAB_XYZ_TRIP_CASES[LAB_XYZ_TRIP_COUNT] = {
	{62.49662458685613, 15.921968235103208, 43.94206365070704},
	{60.225729256370386, -65.90701269229532, -122.8715591959677},
	{70.70395744142604, 47.72033306110339, -67.28965227226371},
	{10.565626484146385, 14.399253629598746, -57.7517299382402},
	{37.94470981789585, 100.9216409015016, -70.81919846542519},
	{65.42848299310512, -87.14180849916056, -93.62261372941602},
	{25.14535692478086, 20.830641521450787, 10.049191399585112},
	{86.39186630711771, 41.08499538565434, 19.32879505384227},
	{47.43578572203164, 106.42601962887187, 106.39301885620529},
	{59.86750048733658, -106.85105416067564, 68.47935001874336},
	{76.4516511080957, 91.98713012134218, 36.219248657720556},
	{43.67872114019139, 63.225774859092326, -107.18215415890641},
	{16.841159957213257, 124.27126541859869, 39.15838042214344},
	{7.941834023497096, -123.57329343380124, 25.865472483205423},
	{85.33704034711613, -64.36013159092579, -13.345517302370268},
	{57.50627050542304, 29.804438570764347, 74.11952174130761},
	{95.59661708578943, 70.43465276038617, 62.175132874595846},
	{24.1286752785293, -16.097116688685404, -58.96612493552611},
	{92.96386326028706, -98.91748928853595, -8.42631004460884},
	{65.22568000291658, 103.900475340495, -33.32010142739247},
	{40.42394003161317, -75.80598971965182, -96.37551120847196},
	{10.492308164229936, 4.952126219178126, -96.69045870019902},
	{88.10241619379376, -16.408865049051755, -24.97394921125607},
	{15.572499805870022, 80.95467581004422, 85.57774464131396},
	{51.85308774884644, -10.868588642399118, -99.36797107063441},
	{16.2161227463803, 62.65882535386933, 85.86755277395099},
	{81.04278036952407, -99.14625045147773, 6.447486582682387},
	{38.00858886161811, -71.38055412756933, -72.3786879996724},
	{98.40597957385198, 48.00220617692099, 102.19088124747529},
	{5.270246741752372, 50.07246855462941, 89.07995884566469},
	{34.10604610138475, -115.94440049481506, 81.3325882519731},
	{73.68405777666128, 113.07519173514936, -41.08792944044865},
	{6.766656290770534, -1.4851276974585659, -30.812836015323526},
	{20.69677976393566, 73.48844876958992, 76.54123770244107},
	{63.2862472419936, -88.212844708163, 48.28325546022003},
	{41.82162062560809, -63.55887179326542, 40.06323545160191},
	{40.06351290056155, -110.01693126328196, -85.90720749343278},
	{63.285157292877145, -42.478420328557675, -74.98751046284087},
	{10.428725426654006, 112.79936994447758, 52.809113551407336},
	{81.21069766124619, -124.99828559169437, -1.6891715090303876},
	{97.4410701691364, 48.90358069901026, 88.66909032680994},
	{81.24816423533761, 65.60508451452804, -5.235463270904347},
	{3.4541717742531564, -9.157841927660414, 70.53655947922127},
	{85.97385745156625, 17.973805062786198, -75.66419878945396},
	{87.65906261368163, -24.671563148337626, -19.37037625861754},
	{96.24452567932481, 5.616024649389942, 33.88063616101368},
	{11.107480671339442, 67.07978728394212, -53.69736655896685},
	{38.78516677737779, 97.29263992356624, -11.612541135410353},
	{87.07984004551945, 104.75440970981944, -114.99426735483756},
	{53.48513993315375, 79.30625855441835, 44.8761160917646},
};


bool test_LAB_XYZ_roundtrip(void){
 	long different = 0;
    for(long i = 0; i< LAB_XYZ_TRIP_COUNT ;i++){
    	lab_t start = LAB_XYZ_TRIP_CASES[i];
    	lab_t end = LAB_from_XYZ(XYZ_from_LAB(start));
    	start = round_lab(start, 5);
    	end = round_lab(end, 5);

    	if(!lab_equals(start, end)){
    		different += 1;
    	}


    }
    if(different != 0){
    	printf("FAILED: test_LAB_XYZ_roundtrip, LAB->XYZ->LAB round trip returned wrong LAB for %ld values\n", different);
    	return false;
    }else{
	    puts("SUCCESS");
	    return true;
    }

}



#define DATA_PREMADE_COUNT 10

// sRGB D65 2*
const rgb_t PREMADE_RGB[DATA_PREMADE_COUNT] = {
	{198, 139, 72}, 
	{0, 186, 255}, 
	{189, 146, 255}, 
	{0, 30, 111}, 
	{181, 0, 208}, 
	{0, 201, 255}, 
	{92, 46, 45}, 
	{255, 185, 182}, 
	{255, 0, 0}, 
	{0, 178, 0}, 
};

const lab_t PREMADE_LAB[DATA_PREMADE_COUNT] = {
	{62.49662458685613, 15.921968235103208, 43.94206365070704},
    {60.225729256370386, -65.90701269229532, -122.8715591959677},
    {70.70395744142604, 47.72033306110339, -67.28965227226371},
    {10.565626484146385, 14.399253629598746, -57.7517299382402},
    {37.94470981789585, 100.9216409015016, -70.81919846542519},
    {65.42848299310512, -87.14180849916056, -93.62261372941602},
    {25.14535692478086, 20.830641521450787, 10.049191399585112},
    {86.39186630711771, 41.08499538565434, 19.32879505384227},
    {47.43578572203164, 106.42601962887187, 106.39301885620529},
    {59.86750048733658, -106.85105416067564, 68.47935001874336},
};


const xyz_t PREMADE_XYZ[DATA_PREMADE_COUNT] = {
	{33.809, 30.987, 10.391}, 
	{13.778, 28.375, 223.811}, 
	{56.918, 41.758, 138.651}, 
	{1.629, 1.201, 15.114}, 
	{28.190, 10.057, 59.845}, 
	{13.966, 34.590, 174.425}, 
	{5.919, 4.463, 3.073}, 
	{85.375, 68.774, 52.881}, 
	{41.676, 16.354, -1.720}, 
	{8.115, 27.976, 3.295},

};


void temp_test(){
	for(int i=0; i<10; i++){
		print_xyz(PREMADE_XYZ[i]);
		print_xyz(XYZ_from_LAB(PREMADE_LAB[i]));

		putchar('\n');

		print_lab(PREMADE_LAB[i]);
		print_lab(LAB_from_XYZ(PREMADE_XYZ[i]));


		putchar('\n');
		print_rgb(RGB_from_XYZ(PREMADE_XYZ[i]));
		print_rgb(PREMADE_RGB[i]);
		putchar('\n');


	}

}



bool test_premade_XYZ_LAB(void){
	for(int i=0; i<DATA_PREMADE_COUNT;i++){
		lab_t expected = PREMADE_LAB[i];
		lab_t calculated = LAB_from_XYZ(PREMADE_XYZ[i]);

		expected = round_lab(expected, 0);
		calculated = round_lab(calculated, 0);

		// round precision is very low because hardcoded data for XYZ was provided with only 3 digits after dot
		// hence the result is SLIGHTLY off due to rounding errors

		// increase round precision to see what the function returns on failure (should return close but slightly off result)
		bool correct = lab_equals(expected, calculated);
		if(! correct){
			printf("Test test_premade_XYZ_LAB FAILED at:\n");
			print_xyz(PREMADE_XYZ[i]);
			printf(",\nExpected: ");
			print_lab(expected);
			printf("\nGot: ");
			print_lab(calculated);
			printf("\n");
			return false;
		}

	}

	puts("SUCCESS");
	return true;
}
bool test_premade_LAB_XYZ(void){
	for(int i=0; i<DATA_PREMADE_COUNT;i++){
		xyz_t calculated = XYZ_from_LAB(PREMADE_LAB[i]);
		xyz_t expected = PREMADE_XYZ[i];

		// round precision is very low because hardcoded data for XYZ was provided with only 3 digits after dot
		// hence the result is SLIGHTLY off due to rounding errors
		expected = round_xyz(expected, 1);
		calculated = round_xyz(calculated, 1);

		bool correct = xyz_equals(expected, calculated);
		if(! correct){
			printf("Test test_premade_LAB_XYZ FAILED at:\n");
			print_lab(PREMADE_LAB[i]);
			printf(",\nExpected: ");
			print_xyz(expected);
			printf("\nGot: ");
			print_xyz(calculated);
			printf("\n");
			return false;
		}

	}

	puts("SUCCESS");
	return true;
}

bool test_premade_XYZ_RGB(void){
	for(int i=0; i<DATA_PREMADE_COUNT;i++){
		rgb_t expected = PREMADE_RGB[i];
		rgb_t calculated = RGB_from_XYZ(PREMADE_XYZ[i]);


		bool correct = rgb_equals(expected, calculated);
		if(! correct){
			printf("Test test_premade_XYZ_RGB FAILED at:\n");
			print_rgb(PREMADE_RGB[i]);
			printf(", ");
			print_xyz(PREMADE_XYZ[i]);
			printf("\n");
			return false;
		}

	}

	puts("SUCCESS");
	return true;
}