#include "tests.h"

#include "galba_colormath.h"

#include <stdio.h>
#include <string.h>
#include <math.h>
#include <stdbool.h>



static double round_to_n_digits(double x, unsigned int digits) {
    double fac = pow(10, digits);
    return round(x* fac)/ fac;
}
static void print_lab(lab_t p){
    printf("lab(%lf %lf %lf)", p.l, p.a, p.b);
}


#define CIEDE2000_TEST_COUNT 40

const lab_t CIEDE2000_TEST_INPUTS[CIEDE2000_TEST_COUNT][2] = {
	// Test values taken from:
	// 1 . https://hajim.rochester.edu/ece/sites/gsharma/ciede2000/
	{{50.0000, 2.6772, -79.7751}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, 3.1571, -77.2803}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, 2.8361, -74.0200}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, -1.3802, -84.2814}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, -1.1848, -84.8006}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, -0.9009, -85.5211}, {50.0000, 0.0000, -82.7485}},
	{{50.0000, 0.0000, 0.0000}, {50.0000, -1.0000, 2.0000}},
	{{50.0000, -1.0000, 2.0000}, {50.0000, 0.0000, 0.0000}},
	{{50.0000, 2.4900, -0.0010}, {50.0000, -2.4900, 0.0009}},
	{{50.0000, 2.4900, -0.0010}, { 50.0000, -2.4900, 0.0010}},
	{{50.0000, 2.4900, -0.0010}, { 50.0000, -2.4900, 0.0011}},
	{{50.0000, 2.4900, -0.0010}, { 50.0000, -2.4900, 0.0012}},
	{{50.0000, -0.0010, 2.4900}, { 50.0000, 0.0009, -2.4900}},
	{{50.0000, -0.0010, 2.4900}, { 50.0000, 0.0010, -2.4900}},
	{{50.0000, -0.0010, 2.4900}, { 50.0000, 0.0011, -2.4900}},
	{{50.0000, 2.5000, 0.0000}, { 50.0000, 0.0000, -2.5000}},
	{{50.0000, 2.5000, 0.0000}, { 73.0000, 25.0000, -18.0000}},
	{{50.0000, 2.5000, 0.0000}, { 61.0000, -5.0000, 29.0000}},
	{{50.0000, 2.5000, 0.0000}, { 56.0000, -27.0000, -3.0000}},
	{{50.0000, 2.5000, 0.0000}, { 58.0000, 24.0000, 15.0000}},
	{{50.0000, 2.5000, 0.0000}, { 50.0000, 3.1736, 0.5854}},
	{{50.0000, 2.5000, 0.0000}, { 50.0000, 3.2972, 0.0000}},
	{{50.0000, 2.5000, 0.0000}, { 50.0000, 1.8634, 0.5757}},
	{{50.0000, 2.5000, 0.0000}, { 50.0000, 3.2592, 0.3350}},
	{{60.2574, -34.0099, 36.2677}, { 60.4626, -34.1751, 39.4387}},
	{{63.0109, -31.0961, -5.8663}, { 62.8187, -29.7946, -4.0864}},
	{{61.2901, 3.7196, -5.3901}, { 61.4292, 2.2480, -4.9620}},
	{{35.0831, -44.1164, 3.7933}, { 35.0232, -40.0716, 1.5901}},
	{{22.7233, 20.0904, -46.6940}, { 23.0331, 14.9730, -42.5619}},
	{{36.4612, 47.8580, 18.3852}, { 36.2715, 50.5065, 21.2231}},
	{{90.8027, -2.0831, 1.4410}, { 91.1528, -1.6435, 0.0447}},
	{{90.9257, -0.5406, -0.9208}, { 88.6381, -0.8985, -0.7239}},
	{{6.7747, -0.2908, -2.4247}, { 5.8714, -0.0985, -2.2286}},
	{{2.0776, 0.0795, -1.1350}, { 0.9033, -0.0636, -0.5514}},

	// 2. hand picked and cross referenced with websites, including color.js implementation
	{{99.9751541, -0.1694255, 0.465877863506425},{ 100, 0.005260499, -0.0104081845252}},
	{{100.0, -125.0, 125.0},{ 100.0, 125.0, 125.0}},
							// slightly out of bounds inputs
	{{100.01, -125.01, 125.01},{ 100.01, 125.01, 125.01}},      
	{{0.0 ,-125, 125},{100.000001,125.000001,125.000001}},
	{{-0.000001,-125.000001,125.000001},{100,125,125}},                               
	{{0,0,0},{0,0,0}},
};

const double CIEDE2000_TEST_EXPECTED[CIEDE2000_TEST_COUNT] = {
	// 1. 
	2.0425, 2.8615, 3.4412, 1.0000, 1.0000, 1.0000, 2.3669, 2.3669, 
	7.1792, 7.1792, 7.2195, 7.2195, 4.8045, 4.8045, 4.7461, 4.3065, 
	27.1492, 22.8977, 31.9030, 19.4535, 1.0000, 1.0000, 1.0000, 1.0000, 
	1.2644, 1.2630, 1.8731, 1.8645, 2.0373, 1.4146, 1.4441, 1.5381, 0.6377, 0.9082,
	// 2.
	0.537679, 94.77616, 94.7790, 137.77707 ,137.77707, 0.0
};




bool test_CIEDE2000_premade_data(void){

	for(int i=0; i<CIEDE2000_TEST_COUNT; i++){
		double expected = CIEDE2000_TEST_EXPECTED[i];
		double calculated = delta_CIEDE2000(CIEDE2000_TEST_INPUTS[i][0], CIEDE2000_TEST_INPUTS[i][1]);
		double calculated_swap = delta_CIEDE2000(CIEDE2000_TEST_INPUTS[i][1], CIEDE2000_TEST_INPUTS[i][0]);

		expected = round_to_n_digits(expected, 4);
		calculated = round_to_n_digits(calculated, 4);
		calculated_swap = round_to_n_digits(calculated_swap, 4);


		// yes, comparing floats for equality IS DEFINED and PERFECTLY fine. 
		// In this case numbers are rounded in the same way so they are eihter identical or the function returned incorrectly
		bool correct =  expected == calculated && calculated == calculated_swap;
		if(! correct){
			printf("Test test_CIEDE2000_premade_data FAILED at:\n");
			print_lab(CIEDE2000_TEST_INPUTS[i][0]);
			printf(", ");
			print_lab(CIEDE2000_TEST_INPUTS[i][1]);
			printf("\n");

			printf("Expected: %.4lf, calculated: %.4lf, calculated with arguments swapped: %.4lf\n", 
														expected, calculated, calculated_swap);
			return false;
		}

	}

	puts("SUCCESS");
	return true;


}


#define CIEDE2000_TEST_COUNT_NONDEFAULT 51
#define CIEDE2000_PARAMS_NONDEFAULT ((const CIEDE2000_params){.KL = 1.3, .KC = 1.5, .KH = 0.9})


const lab_t CIEDE2000_TEST_INPUTS_NONDEFAULT[CIEDE2000_TEST_COUNT_NONDEFAULT][2] = {
	{{0,0,0}, {0,0,0}},
	{{19.07426, 1.96151, -12.6282},
	{41.18204, -85.66477, 13.2827}},
	{{86.9685, 11.73273, -80.1419},
	{59.66093, -94.88031, -97.494}},
	{{95.49242, 86.15954, 9.0365},
	{12.27245, 66.30477, -97.051}},
	{{8.87424, -88.02779, 10.9865},
	{98.45971, -31.87602, 97.2277}},
	{{97.24331, -53.48255, -121.697},
	{54.60477, -109.1119, 2.1021}},
	{{29.26924, -68.46, -53.7090},
	{50.53589, -91.6694, -10.8370}},
	{{4.05311, 46.76292, -10.2974},
	{47.75872, -88.42087, -97.523}},
	{{75.6337, 3.77448, -2.3268},
	{34.28452, -74.35742, 85.2575}},
	{{76.5749, -93.9658, -42.9919},
	{41.55391, 41.33745, 3.4425}},
	{{26.97951, -57.92439, 11.3254},
	{28.62094, -97.07307, -3.811}},
	{{24.54327, 66.10772, -45.7383},
	{24.37749, 83.84653, -66.3058}},
	{{94.14822, 77.57961, 67.9548},
	{58.29437, -96.51009, 62.0725}},
	{{38.25635, -64.26359, -43.5136},
	{75.38099, -61.54851, 85.1826}},
	{{22.55904, 27.78327, 53.4053},
	{90.12981, 118.40659, -1.6620}},
	{{68.05182, -25.42506, -37.8487},
	{47.89902, 15.69402, 114.1173}},
	{{42.80365, -59.4247, -91.1862},
	{82.71078, 118.46441, -11.7335}},
	{{47.95494, -60.32069, -75.2259},
	{49.74244, 57.0335, -88.6049}},
	{{24.25952, -51.3294, -39.4446},
	{38.56365, 107.87838, -93.9398}},
	{{87.58085, 97.15829, 83.6819},
	{15.6699, 98.95471, 122.9927}},
	{{9.27466, -60.033, 75.2973},
	{32.62005, 48.75302, -79.2551}},
	{{85.54143, 87.89973, -58.1566},
	{92.0309, -71.20206, -121.9430}},
	{{43.24176, -77.01502, -105.5447},
	{69.19417, -85.95033, -119.6041}},
	{{96.55047, -117.44849, -69.2142},
	{97.66486, -40.36809, 28.009}},
	{{90.62523, 14.43017, -10.6778},
	{64.79159, -79.12201, 60.9684}},
	{{30.29552, 83.3482, -40.7039},
	{7.90131, -107.75313, -91.5681}},
	{{25.03612, -7.5626, 88.5431},
	{56.40501, 40.78397, 27.9570}},
	{{4.78074, -14.18519, -81.1569},
	{78.07473, 108.92403, -59.0554}},
	{{30.07035, -25.06591, -122.5539},
	{77.24766, -25.99148, -3.8058}},
	{{17.969, 27.6993, -111.4795},
	{86.10229, -47.08305, 117.9646}},
	{{52.38247, -112.38237, 12.8690},
	{78.10643, -117.97703, 20.1487}},
	{{9.35463, 2.33982, -113.2715},
	{16.4735, -89.15467, -113.6097}},
	{{80.85436, -122.02684, 44.5038},
	{84.46779, -5.38739, 19.8214}},
	{{88.73877, 110.45858, 69.4811},
	{52.99218, 102.64504, -58.3339}},
	{{29.57963, -64.80668, 94.2609},
	{90.02173, -98.33034, -97.3950}},
	{{77.0123, 53.01813, 123.6249},
	{18.08196, 18.42868, 92.1801}},
	{{70.45663, -27.44334, -54.9957},
	{12.17152, -0.37004, -121.8679}},
	{{81.41289, 23.38511, -36.4035},
	{99.2701, -15.46633, 18.1496}},
	{{88.30896, 34.323, 95.5089},
	{89.1929, 102.25501, -45.2008}},
	{{35.74989, 70.76727, -46.1464},
	{26.60389, -109.622, 113.3380}},
	{{92.61338, 51.66404, -113.9262},
	{95.75985, -12.3256, -72.0811}},
	{{19.01001, -7.89294, 113.9294},
	{71.25716, 95.6533, 29.7146}},
	{{93.07413, 80.65926, -80.9634},
	{88.84632, -115.92271, 104.9102}},
	{{45.34765, 106.73869, 1.6849},
	{47.16896, 124.06428, -107.4560}},
	{{56.87261, -0.5252, 74.0842},
	{48.01823, -34.98865, -46.9436}},
	{{82.97831, -111.18446, 72.56},
	{25.25983, -18.78716, 109.1093}},
	{{75.59044, -99.90531, 29.3084},
	{57.3811, -94.4824, -120.6265}},
	{{47.62155, 40.22989, 120.7313},
	{8.74934, -41.89574, 88.1095}},
	{{89.84322, -13.79232, 63.8488},
	{88.36862, 124.58126, 98.8190}},
	{{38.01458, -20.55966, -89.6370},
	{68.60246, 49.50473, -55.4241}},
	{{99.40319, 33.65668, 19.2292},
	{15.63891, -54.52713, -123.0114}},


};

const double CIEDE2000_TEST_EXPECTED_NONDEFAULT[CIEDE2000_TEST_COUNT_NONDEFAULT] = {
	0,
	34.839852625998056, 39.3642719410122, 72.10234674904575, 76.73378728873477, 50.85100584467276, 
	26.371659800875953, 113.1059594956131, 47.735576633715226, 110.98643756282158, 10.533837935261694, 
	4.31040703632919, 95.55534254093203, 61.4903950834801, 68.21205679756577, 64.14425250519767, 
	131.63061164051803, 57.61265869722471, 67.97746235829895, 56.1721030314811, 74.01590718523583, 
	108.96356140093961, 18.62129067815126, 42.53766336466819, 63.536443405422006, 116.34860764810941, 
	50.8959315554567, 93.98831064489167, 46.76514099407472, 108.27161441428743, 16.429146734833903, 
	28.4927146356742, 27.105797891403878, 46.43937918714207, 83.04692980497722, 46.602380726950926, 
	42.50801525247751, 43.55757030840121, 70.88460753748487, 117.22051879190725, 29.99620063955653, 
	82.63613815522058, 72.8621483562153, 27.550562502913227, 62.605669959276995, 54.95555451855282, 
	55.136017713331164, 49.83807124531308, 61.11270949756064, 62.87507930371434, 91.93108660576064 
};

bool test_CIEDE2000_params_nondefault(void){
	for(int i=0; i<CIEDE2000_TEST_COUNT_NONDEFAULT; i++){
		double expected = CIEDE2000_TEST_EXPECTED_NONDEFAULT[i];

		double calculated = delta_CIEDE2000_full(
			CIEDE2000_TEST_INPUTS_NONDEFAULT[i][0],
			CIEDE2000_TEST_INPUTS_NONDEFAULT[i][1],
			CIEDE2000_PARAMS_NONDEFAULT
		);
		double calculated_swap = delta_CIEDE2000_full(
			CIEDE2000_TEST_INPUTS_NONDEFAULT[i][1],
			CIEDE2000_TEST_INPUTS_NONDEFAULT[i][0],
			CIEDE2000_PARAMS_NONDEFAULT
		);

		expected = round_to_n_digits(expected, 4);
		calculated = round_to_n_digits(calculated, 4);
		calculated_swap = round_to_n_digits(calculated_swap, 4);

		bool correct =  expected == calculated && calculated == calculated_swap;
		if(! correct){
			printf("Test test_CIEDE2000_params_nondefault FAILED at:\n");
			print_lab(CIEDE2000_TEST_INPUTS_NONDEFAULT[i][0]);
			printf(", ");
			print_lab(CIEDE2000_TEST_INPUTS_NONDEFAULT[i][1]);
			printf("\n");

			printf("Expected: %.4lf, calculated: %.4lf, calculated with arguments swapped: %.4lf\n", 
														expected, calculated, calculated_swap);
			return false;
		}

	}

	puts("SUCCESS");
	return true;


}